<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emergency Alert Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body id="body" class="min-h-screen transition-colors duration-300">

<div id="app" class="max-w-6xl mx-auto p-4">
  <header class="mb-6 flex flex-wrap items-center justify-between gap-3">
    <h1 class="text-2xl font-bold">Emergency Alert Monitor</h1>
    <div class="flex gap-2">
      <select id="toneSelect" class="px-2 py-2 rounded bg-slate-700">
        <option value="none">No Tone</option>
        <option value="chime">Tone 1 â€“ Neutral Chime</option>
        <option value="beep">Tone 2 â€“ Triple Beep</option>
        <option value="pulse">Tone 3 â€“ Urgent Pulse</option>
        <option value="voice">Tone 4 â€“ Voice Preface</option>
      </select>
      <button onclick="toggleTheme()" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600">Toggle Theme</button>
      <button onclick="enterTVMode()" class="px-3 py-2 rounded bg-orange-600 hover:bg-orange-500">ðŸ“º TV / ZIP Mode</button>
    </div>
  </header>

  <main id="alerts" class="space-y-3"></main>
  <footer class="mt-6 text-xs opacity-70">Weather + Emergency alerts (CAP). Non-EAS tones used.</footer>
</div>

<!-- TV MODE -->
<div id="tvMode" class="hidden fixed inset-0 bg-black text-white p-6">
  <div id="zipPrompt" class="flex flex-col items-center justify-center h-full gap-4">
    <h2 class="text-3xl font-bold">Enter ZIP Code</h2>
    <input id="zipInput" maxlength="5" inputmode="numeric" class="text-black text-2xl p-3 rounded" placeholder="ZIP" />
    <button onclick="startTVMode()" class="px-6 py-3 text-xl rounded bg-red-600">Start Alerts</button>
  </div>

  <div id="tvCarousel" class="hidden h-full flex flex-col justify-between">
    <div>
      <div class="flex justify-between items-center">
        <h2 id="tvEvent" class="text-4xl font-bold"></h2>
        <div id="tvTemp" class="text-3xl"></div>
      </div>
      <p id="tvSeverity" class="text-xl mb-2"></p>
      <p id="tvHeadline" class="text-2xl"></p>
    </div>
    <pre id="tvInstructions" class="text-xl whitespace-pre-wrap"></pre>
    <div class="text-sm opacity-70">Extreme alerts preempt â€¢ Auto-advancing</div>
  </div>
</div>

<script>
/* =========================
   THEME
   ========================= */
function setTheme(t){
  localStorage.setItem('theme', t);
  document.body.className = t === 'dark'
    ? 'bg-slate-950 text-slate-100 min-h-screen transition-colors duration-300'
    : 'bg-slate-100 text-slate-900 min-h-screen transition-colors duration-300';
}
function toggleTheme(){ setTheme((localStorage.getItem('theme')||'dark')==='dark'?'light':'dark'); }
setTheme(localStorage.getItem('theme') || 'dark');

/* =========================
   SAFE ALERT TONES (NONâ€‘EAS)
   ========================= */
let audioCtx;
function ctx(){ return audioCtx ||= new (window.AudioContext||window.webkitAudioContext)(); }

function playTone(){
  const mode = document.getElementById('toneSelect').value;
  if(mode === 'none') return;

  if(mode === 'voice'){
    speechSynthesis.speak(new SpeechSynthesisUtterance('Emergency alert. Attention required.'));
    return;
  }

  const c = ctx();
  const o = c.createOscillator();
  const g = c.createGain();
  o.connect(g); g.connect(c.destination);

  if(mode === 'chime'){
    o.frequency.value = 880; g.gain.value = 0.2; o.start(); o.stop(c.currentTime + 0.4);
  }
  if(mode === 'beep'){
    o.frequency.value = 1000; g.gain.value = 0.25; o.start(); o.stop(c.currentTime + 0.15);
    setTimeout(()=>{ const o2=c.createOscillator();const g2=c.createGain();o2.connect(g2);g2.connect(c.destination);o2.frequency.value=1000;g2.gain.value=0.25;o2.start();o2.stop(c.currentTime+0.15);},300);
    setTimeout(()=>{ const o3=c.createOscillator();const g3=c.createGain();o3.connect(g3);g3.connect(c.destination);o3.frequency.value=1000;g3.gain.value=0.25;o3.start();o3.stop(c.currentTime+0.15);},600);
  }
  if(mode === 'pulse'){
    o.frequency.value = 600; g.gain.setValueAtTime(0.3,c.currentTime); g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+1.2); o.start(); o.stop(c.currentTime+1.2);
  }
}

/* =========================
   DATA + TV LOGIC (UNCHANGED CORE)
   ========================= */
let allAlerts=[], easAlerts=[], tvAlerts=[], tvIndex=0, currentCounty='';

async function loadAlerts(){
  const res = await fetch('https://api.weather.gov/alerts/active');
  const data = await res.json();
  allAlerts = data.features || [];
  easAlerts = allAlerts.filter(a=>a.properties?.severity==='Extreme');
}

async function zipToCounty(zip){
  const r = await fetch(`https://api.zippopotam.us/us/${zip}`);
  const d = await r.json();
  return d.places[0]['county'] || d.places[0]['place name'];
}

function enterTVMode(){ document.getElementById('tvMode').classList.remove('hidden'); }

async function startTVMode(){
  const zip = zipInput.value;
  if(!/^\d{5}$/.test(zip)) return alert('Invalid ZIP');
  currentCounty = await zipToCounty(zip);
  tvAlerts = allAlerts.filter(a=>(a.properties.areaDesc||'').includes(currentCounty));
  zipPrompt.classList.add('hidden'); tvCarousel.classList.remove('hidden'); tvIndex=0;
  cycleTVAlerts();
}

function cycleTVAlerts(){
  const priority = easAlerts.filter(a=>(a.properties.areaDesc||'').includes(currentCounty));
  const a = priority[0] || tvAlerts[tvIndex]; if(!a) return;
  const p = a.properties;
  tvEvent.textContent = p.event; tvSeverity.textContent = p.severity;
  tvHeadline.textContent = p.headline||''; tvInstructions.textContent = p.instruction||p.description||'';
  playTone(); autoSpeak(p); tvIndex=(tvIndex+1)%tvAlerts.length;
}

function autoSpeak(p){
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(`${p.event}. ${p.headline||''}. ${p.instruction||''}`);
  u.onend = ()=>setTimeout(cycleTVAlerts,30000);
  speechSynthesis.speak(u);
}

/* =========================
   TESTS
   ========================= */
(function(){
  console.assert(typeof playTone==='function');
  console.assert(!navigator.mediaDevices?.getDisplayMedia);
})();

loadAlerts();
</script>
</body>
</html>
